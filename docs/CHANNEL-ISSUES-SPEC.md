# FreeTube Web - Channel Issues Specification

## Issue 1: Channel Logo Broken Images (破圖)

### Problem Description
Channel logos/avatars appear as broken images throughout the app:
- Video watch page: Channel avatar next to video info
- Search results: Channel thumbnails in channel search results
- Recommendations: Channel avatars in related videos

### Root Cause
The `authorThumbnails` field returned from `local-api-server.js` contains raw YouTube URLs (e.g., `https://yt3.ggpht.com/...`) which are:
1. Blocked by CORS when loaded directly in the browser
2. Not converted to proxy URLs like video thumbnails are

### Current Behavior
```javascript
// In local-api-server.js - video endpoint
return {
  // ...
  authorThumbnails: [],  // Empty array - no channel avatar for video info
}

// In search results
const authorThumbnails = [
  { url: thumbUrl, width: 32, height: 32 },  // thumbUrl is proxied for search
  // ...
]
```

### Expected Behavior
All channel avatars should be proxied through `/ggpht/` endpoint:
- Input: `https://yt3.ggpht.com/ytc/ABC123`
- Output: `/ggpht/ytc/ABC123`

### Files to Modify
1. `local-api-server.js`
   - `convertVideoInfo()`: Add `authorThumbnails` with proxied URLs
   - `convertRelatedVideos()`: Add `authorThumbnails` for each related video

### Implementation Steps
1. Create helper function `toGgphtProxyUrl(url)` to convert ggpht URLs
2. In video info endpoint, fetch channel avatar from `info.basic_info` or separate channel call
3. Add `authorThumbnails` array with multiple sizes (32, 48, 76, 176 pixels)
4. Ensure related videos also have `authorThumbnails` populated

### Test Cases
- [ ] Video watch page shows channel avatar
- [ ] Search results show channel avatars
- [ ] Related videos show channel avatars
- [ ] No broken image icons appear

---

## Issue 2: Channel Page Crash (頻道頁面崩潰)

### Problem Description
Navigating to a channel page (e.g., `/#/channel/UCyr3ZnMUoYAEncZqe9YiYgg`) causes the page to crash or show errors.

### Root Cause
The `local-api-server.js` channel endpoint returns incomplete data that doesn't match the Invidious API format expected by `Channel.vue`.

### Current Response (Incomplete)
```javascript
{
  author: 'Channel Name',
  authorId: 'UCxxx',
  authorBanners: [],      // Raw YouTube format, not Invidious format
  authorThumbnails: [],   // Raw YouTube format, not Invidious format
  description: '',
  subCount: 0,
  totalViews: 0,
  joined: 0,
  latestVideos: [],       // Empty, no videos fetched
  // MISSING: tabs, isFamilyFriendly, relatedChannels
}
```

### Expected Response (Invidious Format)
```javascript
{
  author: 'Channel Name',
  authorId: 'UCxxx',
  authorUrl: '/channel/UCxxx',
  authorVerified: false,
  authorBanners: [{ url: '/ggpht/...', width: 1280, height: 720 }],
  authorThumbnails: [
    { url: '/ggpht/...', width: 32, height: 32 },
    { url: '/ggpht/...', width: 48, height: 48 },
    { url: '/ggpht/...', width: 76, height: 76 },
    { url: '/ggpht/...', width: 176, height: 176 },
  ],
  subCount: 1000000,
  totalViews: 500000000,
  joined: 1420070400,  // Unix timestamp
  autoGenerated: false,
  isFamilyFriendly: true,
  description: 'Channel description...',
  descriptionHtml: '<p>Channel description...</p>',
  allowedRegions: ['US', 'TW', ...],
  tabs: ['videos', 'shorts', 'live', 'playlists', 'community', 'about'],
  latestVideos: [...],   // Array of video objects
  relatedChannels: [...] // Array of related channel objects
}
```

### Files to Modify
1. `local-api-server.js`
   - Implement full channel endpoint with all required fields
   - Add channel tabs detection
   - Add channel videos tab endpoint (`/api/v1/channels/:id/videos`)
   - Add channel shorts tab endpoint (`/api/v1/channels/:id/shorts`)
   - Add channel playlists endpoint (`/api/v1/channels/:id/playlists`)
   - Add channel community endpoint (`/api/v1/channels/:id/community`)

### Implementation Steps

#### Step 1: Enhance Channel Info Endpoint
```javascript
// GET /api/v1/channels/:channelId
const channel = await innertube.getChannel(channelId)

// Extract available tabs
const tabs = []
if (channel.has_videos) tabs.push('videos')
if (channel.has_shorts) tabs.push('shorts')
if (channel.has_live_streams) tabs.push('live')
if (channel.has_playlists) tabs.push('playlists')
if (channel.has_community) tabs.push('community')
tabs.push('about')

// Convert thumbnails to proxy URLs
const authorThumbnails = (channel.metadata?.avatar || []).map(thumb => ({
  url: toGgphtProxyUrl(thumb.url),
  width: thumb.width,
  height: thumb.height
}))

// Return full response
return {
  author: channel.metadata?.title,
  authorId: channelId,
  authorUrl: `/channel/${channelId}`,
  authorThumbnails,
  authorBanners: convertBanners(channel.metadata?.banner),
  subCount: parseSubscriberCount(channel.metadata?.subscriber_count),
  isFamilyFriendly: channel.metadata?.is_family_safe ?? true,
  tabs,
  latestVideos: convertVideos(channel.videos || []),
  relatedChannels: [],
  // ... other fields
}
```

#### Step 2: Add Channel Tab Endpoints
```javascript
// GET /api/v1/channels/:channelId/videos
// GET /api/v1/channels/:channelId/shorts
// GET /api/v1/channels/:channelId/playlists
// GET /api/v1/channels/:channelId/community
```

### Test Cases
- [ ] Channel page loads without errors
- [ ] Channel banner displays correctly
- [ ] Channel avatar displays correctly
- [ ] Videos tab shows channel videos
- [ ] Shorts tab shows channel shorts (if available)
- [ ] About tab shows channel description
- [ ] Subscribe button works

---

## Priority
1. **High**: Channel page crash - Blocks entire feature
2. **Medium**: Channel logo broken - Visual issue but functional

## Estimated Effort
- Issue 1 (Channel Logo): ~1 hour
- Issue 2 (Channel Page): ~3-4 hours

## Dependencies
- `youtubei.js` library for fetching channel data
- Understanding of Invidious API format
